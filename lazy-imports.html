<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../polymer/polymer.html">

<!--
`lazy-imports`
Declarative lazy imports

@demo demo/index.html
-->
<script>
/** @polymerBehavior */
var LazyImportsBehavior = {
  _recordActivation: function(group) {
    if (!this._activatedImports) {
      this._activatedImports = new Set();
    }
    if (this._activatedImports.has(group)) {
      return false;
    }
    this._activatedImports.add(group);
  },
  importLazyGroup: function(group) {
    // TODO(garlicnation): Test this more thoroughly. It should be possible to
    // recover from a variety of error conditions.
    // if (!this._recordActivation(group)) {
    //   return;
    // }
    var domModule = Polymer.DomModule.import(this.localName);
    var groupAttribute = '';
    if (group) {
      groupAttribute = `[group=${group}]`;
    }
    var query = `link${groupAttribute}[rel='lazy-import'][href]`
    var imports = domModule.querySelectorAll(query);
    var i, href;
    var promises = [];
    for (i = 0; i < imports.length; i++) {
      promises.push(new Promise((resolve, reject) => {
        var href = imports[i].getAttribute('href');
        if (!href || href.length == 0) {
          return;
        }
        var onLoad = function() {
          console.log("loaded");
          resolve({loaded: href});
        }
        var onFailure = function() {
          resolve({failed: href});
        }
        this.importHref(this.resolveUrl(href), onLoad, onFailure);
      }));
    }
    return Promise.all(promises).then(function(importRequests){
      console.log("Everything done!");
      return importRequests.reduce(function(requests, nextRequest) {
        if (nextRequest.loaded) {
          requests.loaded.push(nextRequest.loaded);
        }
        if (nextRequest.failed) {
          requests.loaded.push(nextRequest.failed);
        }
        return requests;
      }, {loaded: [], failed: []})
    });
  }
}
</script>
